<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Order Wizard - Emily Bakes Cakes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@400;600&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="dashboard/js/unified-mock-data.js"></script>
    <style>
        :root {
            --primary: #C44569;
            --primary-dark: #A33854;
            --accent: #F8EBD7;
            --text: #2B2B2B;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --success: #10B981;
            --danger: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(135deg, var(--accent) 0%, #E9E9E9 100%);
            min-height: 100vh;
            color: var(--text);
        }

        .wizard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .wizard-header {
            background: white;
            padding: 30px;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .wizard-title {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-top: 30px;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--border);
            z-index: 0;
        }

        .progress-bar-fill {
            position: absolute;
            top: 20px;
            left: 0;
            height: 4px;
            background: var(--primary);
            transition: width 0.3s;
            z-index: 1;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            z-index: 2;
            background: white;
            padding: 0 10px;
        }

        .progress-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .progress-step.active .progress-step-circle {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .progress-step.completed .progress-step-circle {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .progress-step-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-align: center;
        }

        .progress-step.active .progress-step-label {
            color: var(--primary);
        }

        .wizard-body {
            background: white;
            padding: 40px;
            min-height: 500px;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            font-family: 'Poppins', sans-serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
        }

        .step-subtitle {
            color: var(--text-light);
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--accent);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .required {
            color: var(--danger);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group input.error,
        .form-group select.error {
            border-color: var(--danger);
        }

        .help-text {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .error-text {
            font-size: 12px;
            color: var(--danger);
            margin-top: 4px;
        }

        .search-box {
            position: relative;
            margin-bottom: 30px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--border);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: var(--accent);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .customer-card {
            background: var(--accent);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .customer-card h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .layer-section {
            background: #F9FAFB;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--border);
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .layer-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
        }

        .btn-remove-layer {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .btn-remove-layer:hover {
            opacity: 0.8;
        }

        .btn-add-layer {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.2s;
        }

        .btn-add-layer:hover {
            opacity: 0.9;
        }

        .photo-upload {
            border: 2px dashed var(--border);
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-upload:hover {
            border-color: var(--primary);
            background: var(--accent);
        }

        .photo-previews {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .photo-preview {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 25px;
            border-radius: 12px;
            position: sticky;
            top: 20px;
        }

        .summary-card h3 {
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 18px;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        .wizard-footer {
            background: white;
            padding: 20px 40px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(196, 69, 105, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--accent);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #DBEAFE;
            color: #1E40AF;
            border: 1px solid #3B82F6;
        }

        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid var(--success);
        }

        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid var(--danger);
        }

        .two-col-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .two-col-layout {
                grid-template-columns: 1fr;
            }

            .summary-card {
                position: static;
            }

            .wizard-body {
                padding: 20px;
            }

            .wizard-header {
                padding: 20px;
            }

            .wizard-footer {
                padding: 15px 20px;
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .progress-step-label {
                font-size: 10px;
            }
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .review-section {
            background: var(--accent);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .review-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .review-detail {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #DDD;
        }

        .review-detail:last-child {
            border-bottom: none;
        }

        .review-label {
            font-weight: 600;
            color: var(--text);
        }

        .review-value {
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <!-- HEADER -->
        <div class="wizard-header">
            <h1 class="wizard-title">üéÇ New Cake Order Wizard</h1>
            
            <!-- PROGRESS BAR -->
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressFill"></div>
                <div class="progress-step active" data-step="1">
                    <div class="progress-step-circle">1</div>
                    <div class="progress-step-label">Customer</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="progress-step-circle">2</div>
                    <div class="progress-step-label">Cake Details</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="progress-step-circle">3</div>
                    <div class="progress-step-label">Customization</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="progress-step-circle">4</div>
                    <div class="progress-step-label">Review</div>
                </div>
            </div>
        </div>

        <!-- BODY -->
        <div class="wizard-body">
            <!-- STEP 1: CUSTOMER LOOKUP/ADD -->
            <div class="wizard-step active" data-step="1">
                <h2 class="step-title">Step 1: Customer Information</h2>
                <p class="step-subtitle">Search for an existing customer or add a new one</p>

                <div class="search-box">
                    <div class="form-group">
                        <label>Search Customer (by name, phone, or email)</label>
                        <input type="text" id="customerSearch" placeholder="Type to search...">
                    </div>
                    <div class="search-results" id="searchResults"></div>
                </div>

                <div id="selectedCustomerCard" style="display: none;">
                    <div class="customer-card">
                        <h4>Selected Customer</h4>
                        <p id="customerDisplay"></p>
                        <button type="button" class="btn btn-secondary" onclick="clearCustomer()" style="margin-top: 10px;">Change Customer</button>
                    </div>
                </div>

                <div id="addCustomerSection">
                    <div class="alert alert-info">
                        <span>üë§</span>
                        <span>Customer not found? Add a new customer below.</span>
                    </div>

                    <div class="form-section">
                        <div class="section-title">üë§ Personal Information</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>First Name <span class="required">*</span></label>
                                <input type="text" id="firstName" required>
                            </div>
                            <div class="form-group">
                                <label>Last Name <span class="required">*</span></label>
                                <input type="text" id="lastName" required>
                            </div>
                            <div class="form-group">
                                <label>Mobile Phone <span class="required">*</span></label>
                                <input type="tel" id="mobilePhone" required placeholder="(123) 456-7890">
                                <span class="help-text">Format: (123) 456-7890</span>
                            </div>
                            <div class="form-group">
                                <label>Email <span class="required">*</span></label>
                                <input type="email" id="email" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-title">üìç Address</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Address Line 1 <span class="required">*</span></label>
                                <input type="text" id="addressLine1" required>
                            </div>
                            <div class="form-group">
                                <label>Address Line 2</label>
                                <input type="text" id="addressLine2">
                            </div>
                            <div class="form-group">
                                <label>State <span class="required">*</span></label>
                                <select id="state" required>
                                    <option value="">-- Select State --</option>
                                    <option value="TX" selected>Texas</option>
                                    <option value="CA">California</option>
                                    <option value="NY">New York</option>
                                    <option value="FL">Florida</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ZIP Code <span class="required">*</span></label>
                                <input type="text" id="zipCode" required placeholder="12345">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 2: CAKE SELECTION -->
            <div class="wizard-step" data-step="2">
                <h2 class="step-title">Step 2: Cake Details</h2>
                <p class="step-subtitle">Select cake size and configure layers</p>

                <div class="two-col-layout">
                    <div>
                        <div class="form-section">
                            <div class="section-title">üç∞ Cake Size</div>
                            <div class="form-group">
                                <label>Select Cake Size <span class="required">*</span></label>
                                <select id="cakeSize" required onchange="updatePricing()">
                                    <option value="">-- Select Size --</option>
                                    <option value="6-inch|20|4-6">6" Round Double Layer (Serves 4-6) - $20</option>
                                    <option value="8-inch|30|12-15">8" Round Double Layer (Serves 12-15) - $30</option>
                                    <option value="10-inch|60|25-30">10" Round Double Layer (Serves 25-30) - $60</option>
                                    <option value="12-inch|100|35">12" Round Double Layer (Serves 35) - $100</option>
                                    <option value="14-inch|140|40">14" Round Double Layer (Serves 40) - $140</option>
                                    <option value="16-inch|180|85">16" Round Double Layer (Serves 85) - $180</option>
                                    <option value="quarter-sheet|40|15-20">¬º Sheet Double Layer (Serves 15-20) - $40</option>
                                    <option value="half-sheet|100|30-50">¬Ω Sheet Double Layer (Serves 30-50) - $100</option>
                                    <option value="full-sheet|200|90-100">Full Sheet Double Layer (Serves 90-100) - $200</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">üéÇ Cake Layers</div>
                            <div id="layersContainer"></div>
                            <button type="button" class="btn-add-layer" onclick="addLayer()">
                                <span>‚ûï</span>
                                <span>Add Another Layer</span>
                            </button>
                        </div>

                        <div class="form-section">
                            <div class="section-title">üìÖ Pickup Details</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Pickup Date <span class="required">*</span></label>
                                    <input type="date" id="pickupDate" required onchange="validatePickupDate()">
                                    <span class="help-text">Minimum 2 days from today</span>
                                </div>
                                <div class="form-group">
                                    <label>Pickup Time <span class="required">*</span></label>
                                    <input type="time" id="pickupTime" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="summary-card" id="pricingSummary">
                            <h3>üí∞ Price Summary</h3>
                            <div class="summary-item">
                                <span>Base Cake:</span>
                                <span id="summaryBaseCake">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <span>Extra Layers:</span>
                                <span id="summaryExtraLayers">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <span>Reference Photos:</span>
                                <span id="summaryPhotos">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <span>TOTAL:</span>
                                <span id="summaryTotal">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <span>Deposit (50%):</span>
                                <span id="summaryDeposit">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 3: CUSTOMIZATION -->
            <div class="wizard-step" data-step="3">
                <h2 class="step-title">Step 3: Customization</h2>
                <p class="step-subtitle">Add writing, decorations, and special instructions</p>

                <div class="form-section">
                    <div class="section-title">‚úçÔ∏è Writing on Cake</div>
                    <div class="form-group">
                        <label>Message on Cake</label>
                        <input type="text" id="cakeWriting" placeholder="e.g., Happy Birthday, Congratulations">
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">üé® Decorations</div>
                    <div class="form-group">
                        <label>Decoration Details</label>
                        <select id="decorationDetails">
                            <option value="">-- Select Decoration --</option>
                            <option value="fresh-flowers">Fresh Flowers</option>
                            <option value="buttercream-flowers">Buttercream Flowers</option>
                            <option value="fondant-figures">Fondant Figures</option>
                            <option value="edible-image">Edible Image Print</option>
                            <option value="gold-leaf">Gold Leaf Accents</option>
                            <option value="sprinkles">Sprinkles & Confetti</option>
                            <option value="custom">Custom Design (describe in notes)</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">üìù Special Instructions</div>
                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea id="specialInstructions" rows="4" placeholder="Any special requests, dietary restrictions, or design details..."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">üì∏ Reference Photos</div>
                    <div class="photo-upload" onclick="document.getElementById('photoUpload').click()">
                        <p>üì∑ Click to upload reference photos</p>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">$10 per photo</p>
                    </div>
                    <input type="file" id="photoUpload" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(event)">
                    <div class="photo-previews" id="photoPreviews"></div>
                </div>
            </div>

            <!-- STEP 4: REVIEW -->
            <div class="wizard-step" data-step="4">
                <h2 class="step-title">Step 4: Review & Submit</h2>
                <p class="step-subtitle">Please review your order details before submitting</p>

                <div class="review-section">
                    <h4>üë§ Customer Information</h4>
                    <div id="reviewCustomer"></div>
                </div>

                <div class="review-section">
                    <h4>üç∞ Cake Details</h4>
                    <div id="reviewCake"></div>
                </div>

                <div class="review-section">
                    <h4>üé® Customization</h4>
                    <div id="reviewCustomization"></div>
                </div>

                <div class="review-section">
                    <h4>üí∞ Pricing</h4>
                    <div id="reviewPricing"></div>
                </div>

                <div class="alert alert-info">
                    <span>‚ÑπÔ∏è</span>
                    <span>By submitting this order, you confirm all details are correct. The customer will be notified of their order status.</span>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="wizard-footer">
            <button type="button" class="btn btn-secondary" id="btnBack" onclick="previousStep()" style="display: none;">
                ‚Üê Back
            </button>
            <div style="flex: 1;"></div>
            <button type="button" class="btn btn-primary" id="btnNext" onclick="nextStep()">
                Next ‚Üí
            </button>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let selectedCustomer = null;
        let layerCount = 0;
        let uploadedPhotos = [];
        let orderData = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeWizard();
            addLayer(); // Add first layer by default
            addLayer(); // Add second layer (double layer default)
            setMinPickupDate();
            
            // Phone formatting
            document.getElementById('mobilePhone').addEventListener('input', function(e) {
                formatPhoneNumber(e.target);
            });

            // Customer search
            document.getElementById('customerSearch').addEventListener('input', function(e) {
                searchCustomers(e.target.value);
            });
        });

        function initializeWizard() {
            updateProgressBar();
            updateButtons();
        }

        function formatPhoneNumber(input) {
            const value = input.value.replace(/\D/g, '');
            if (value.length <= 3) {
                input.value = value ? `(${value}` : '';
            } else if (value.length <= 6) {
                input.value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            } else {
                input.value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
            }
        }

        function searchCustomers(query) {
            const results = document.getElementById('searchResults');
            
            if (!query || query.length < 2) {
                results.classList.remove('show');
                return;
            }

            const customers = unifiedMockData.customers.filter(c => {
                const searchStr = `${c.firstName} ${c.lastName} ${c.mobilePhone} ${c.email}`.toLowerCase();
                return searchStr.includes(query.toLowerCase());
            });

            if (customers.length === 0) {
                results.innerHTML = '<div class="search-result-item">No customers found</div>';
                results.classList.add('show');
                return;
            }

            results.innerHTML = customers.slice(0, 5).map(c => `
                <div class="search-result-item" onclick='selectCustomer(${JSON.stringify(c)})'>
                    <strong>${c.firstName} ${c.lastName}</strong><br>
                    <small>${c.mobilePhone} ‚Ä¢ ${c.email}</small>
                </div>
            `).join('');
            results.classList.add('show');
        }

        function selectCustomer(customer) {
            selectedCustomer = customer;
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('customerSearch').value = '';
            document.getElementById('addCustomerSection').style.display = 'none';
            document.getElementById('selectedCustomerCard').style.display = 'block';
            document.getElementById('customerDisplay').innerHTML = `
                <strong>${customer.firstName} ${customer.lastName}</strong><br>
                ${customer.mobilePhone}<br>
                ${customer.email}<br>
                ${customer.addressLine1}, ${customer.zipCode}
            `;
        }

        function clearCustomer() {
            selectedCustomer = null;
            document.getElementById('selectedCustomerCard').style.display = 'none';
            document.getElementById('addCustomerSection').style.display = 'block';
        }

        function addLayer() {
            layerCount++;
            const container = document.getElementById('layersContainer');
            const layerHTML = `
                <div class="layer-section" id="layer${layerCount}">
                    <div class="layer-header">
                        <div class="layer-title">Layer ${layerCount}</div>
                        ${layerCount > 1 ? `<button type="button" class="btn-remove-layer" onclick="removeLayer(${layerCount})">‚úï Remove</button>` : ''}
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Cake Flavor <span class="required">*</span></label>
                            <select required onchange="updatePricing()">
                                <option value="">-- Select --</option>
                                <option value="vanilla">Vanilla</option>
                                <option value="almond">Almond</option>
                                <option value="yellow">Yellow</option>
                                <option value="devils-food">Devil's Food Chocolate</option>
                                <option value="chocolate">Chocolate</option>
                                <option value="strawberry">Strawberry</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filling <span class="required">*</span></label>
                            <select required>
                                <option value="">-- Select --</option>
                                <option value="white-buttercream">White Buttercream</option>
                                <option value="chocolate-buttercream">Chocolate Buttercream</option>
                                <option value="almond-buttercream">Almond Buttercream</option>
                                <option value="cream-cheese">Cream Cheese</option>
                                <option value="lemon-curd">Lemon Curd</option>
                                <option value="strawberry">Strawberry</option>
                                <option value="raspberry">Raspberry</option>
                                <option value="pecan-praline">Pecan Praline</option>
                                <option value="chocolate-mousse">Chocolate Mousse</option>
                                <option value="lemon-mousse">Lemon Mousse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Icing Flavor <span class="required">*</span></label>
                            <select required>
                                <option value="">-- Select --</option>
                                <option value="white-buttercream">White Buttercream</option>
                                <option value="chocolate-buttercream">Chocolate Buttercream</option>
                                <option value="almond-buttercream">Almond Buttercream</option>
                                <option value="white-chocolate-buttercream">White Chocolate Buttercream</option>
                                <option value="cream-cheese">Cream Cheese</option>
                                <option value="chocolate-ganache">Chocolate Ganache</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Icing Color <span class="required">*</span></label>
                            <select required>
                                <option value="">-- Select --</option>
                                <optgroup label="Primary Colors">
                                    <option value="white">White</option>
                                    <option value="black">Black</option>
                                    <option value="red">Red</option>
                                    <option value="blue">Blue</option>
                                    <option value="yellow">Yellow</option>
                                    <option value="green">Green</option>
                                </optgroup>
                                <optgroup label="Pastel Colors">
                                    <option value="pastel-pink">Pastel Pink</option>
                                    <option value="pastel-blue">Pastel Blue</option>
                                    <option value="pastel-yellow">Pastel Yellow</option>
                                    <option value="pastel-green">Pastel Green</option>
                                    <option value="pastel-purple">Pastel Purple</option>
                                </optgroup>
                                <optgroup label="Metallic">
                                    <option value="gold">Gold</option>
                                    <option value="silver">Silver</option>
                                    <option value="rose-gold">Rose Gold</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', layerHTML);
            updatePricing();
        }

        function removeLayer(layerId) {
            const layer = document.getElementById(`layer${layerId}`);
            if (layer) {
                layer.remove();
                layerCount--;
                updatePricing();
            }
        }

        function updatePricing() {
            const cakeSizeSelect = document.getElementById('cakeSize');
            if (!cakeSizeSelect.value) {
                document.getElementById('summaryBaseCake').textContent = '$0.00';
                document.getElementById('summaryExtraLayers').textContent = '$0.00';
                document.getElementById('summaryPhotos').textContent = '$0.00';
                document.getElementById('summaryTotal').textContent = '$0.00';
                document.getElementById('summaryDeposit').textContent = '$0.00';
                return;
            }

            const [size, basePrice, serves] = cakeSizeSelect.value.split('|');
            const base = parseFloat(basePrice);
            
            // Count current layers
            const currentLayers = document.querySelectorAll('.layer-section').length;
            
            // Extra layer charge ($5 per layer over 2)
            const extraLayers = Math.max(0, currentLayers - 2);
            const extraLayerCost = extraLayers * 5;
            
            // Photo cost
            const photoCost = uploadedPhotos.length * 10;
            
            // Total
            const total = base + extraLayerCost + photoCost;
            const deposit = total * 0.5;
            
            document.getElementById('summaryBaseCake').textContent = `$${base.toFixed(2)}`;
            document.getElementById('summaryExtraLayers').textContent = `$${extraLayerCost.toFixed(2)}`;
            document.getElementById('summaryPhotos').textContent = `$${photoCost.toFixed(2)}`;
            document.getElementById('summaryTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('summaryDeposit').textContent = `$${deposit.toFixed(2)}`;
        }

        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            const previews = document.getElementById('photoPreviews');
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedPhotos.push({
                        name: file.name,
                        data: e.target.result
                    });
                    
                    const preview = document.createElement('div');
                    preview.className = 'photo-preview';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <button class="photo-preview-remove" onclick="removePhoto(${uploadedPhotos.length - 1})">‚úï</button>
                    `;
                    previews.appendChild(preview);
                    updatePricing();
                };
                reader.readAsDataURL(file);
            });
        }

        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            const previews = document.getElementById('photoPreviews');
            previews.children[index].remove();
            updatePricing();
        }

        function setMinPickupDate() {
            const today = new Date();
            today.setDate(today.getDate() + 2); // Minimum 2 days from today
            const minDate = today.toISOString().split('T')[0];
            document.getElementById('pickupDate').min = minDate;
        }

        function validatePickupDate() {
            const pickupDate = new Date(document.getElementById('pickupDate').value);
            const minDate = new Date();
            minDate.setDate(minDate.getDate() + 2);
            
            if (pickupDate < minDate) {
                alert('Pickup date must be at least 2 days from today');
                document.getElementById('pickupDate').value = '';
                return false;
            }
            return true;
        }

        function validateStep(step) {
            if (step === 1) {
                // Check if customer selected or new customer form filled
                if (selectedCustomer) return true;
                
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const mobilePhone = document.getElementById('mobilePhone').value.trim();
                const email = document.getElementById('email').value.trim();
                const addressLine1 = document.getElementById('addressLine1').value.trim();
                const state = document.getElementById('state').value;
                const zipCode = document.getElementById('zipCode').value.trim();
                
                if (!firstName || !lastName || !mobilePhone || !email || !addressLine1 || !state || !zipCode) {
                    alert('Please fill in all required customer fields or search for an existing customer.');
                    return false;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('Please enter a valid email address.');
                    return false;
                }
                
                return true;
            }
            
            if (step === 2) {
                const cakeSize = document.getElementById('cakeSize').value;
                const pickupDate = document.getElementById('pickupDate').value;
                const pickupTime = document.getElementById('pickupTime').value;
                
                if (!cakeSize || !pickupDate || !pickupTime) {
                    alert('Please select cake size, pickup date, and pickup time.');
                    return false;
                }
                
                // Validate all layers have required fields
                const layers = document.querySelectorAll('.layer-section');
                for (let layer of layers) {
                    const selects = layer.querySelectorAll('select');
                    for (let select of selects) {
                        if (!select.value) {
                            alert('Please fill in all layer details (flavor, filling, icing, color).');
                            return false;
                        }
                    }
                }
                
                return true;
            }
            
            return true;
        }

        function nextStep() {
            if (!validateStep(currentStep)) return;
            
            if (currentStep < 4) {
                // Mark current step as completed
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('completed');
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
                
                currentStep++;
                
                // Activate next step
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');
                
                // Show/hide steps
                document.querySelectorAll('.wizard-step').forEach(step => {
                    step.classList.remove('active');
                });
                document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
                
                if (currentStep === 4) {
                    populateReview();
                }
                
                updateProgressBar();
                updateButtons();
                window.scrollTo(0, 0);
            } else {
                submitOrder();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                // Remove completed from current
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
                
                currentStep--;
                
                // Activate previous step
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('completed');
                
                // Show/hide steps
                document.querySelectorAll('.wizard-step').forEach(step => {
                    step.classList.remove('active');
                });
                document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
                
                updateProgressBar();
                updateButtons();
                window.scrollTo(0, 0);
            }
        }

        function updateProgressBar() {
            const progress = ((currentStep - 1) / 3) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function updateButtons() {
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');
            
            if (currentStep === 1) {
                btnBack.style.display = 'none';
            } else {
                btnBack.style.display = 'inline-flex';
            }
            
            if (currentStep === 4) {
                btnNext.innerHTML = '‚úì Submit Order';
            } else {
                btnNext.innerHTML = 'Next ‚Üí';
            }
        }

        function populateReview() {
            // Customer info
            let customerInfo = '';
            if (selectedCustomer) {
                customerInfo = `
                    <div class="review-detail"><div class="review-label">Name:</div><div class="review-value">${selectedCustomer.firstName} ${selectedCustomer.lastName}</div></div>
                    <div class="review-detail"><div class="review-label">Phone:</div><div class="review-value">${selectedCustomer.mobilePhone}</div></div>
                    <div class="review-detail"><div class="review-label">Email:</div><div class="review-value">${selectedCustomer.email}</div></div>
                    <div class="review-detail"><div class="review-label">Address:</div><div class="review-value">${selectedCustomer.addressLine1}, ${selectedCustomer.zipCode}</div></div>
                `;
            } else {
                customerInfo = `
                    <div class="review-detail"><div class="review-label">Name:</div><div class="review-value">${document.getElementById('firstName').value} ${document.getElementById('lastName').value}</div></div>
                    <div class="review-detail"><div class="review-label">Phone:</div><div class="review-value">${document.getElementById('mobilePhone').value}</div></div>
                    <div class="review-detail"><div class="review-label">Email:</div><div class="review-value">${document.getElementById('email').value}</div></div>
                    <div class="review-detail"><div class="review-label">Address:</div><div class="review-value">${document.getElementById('addressLine1').value}, ${document.getElementById('zipCode').value}</div></div>
                `;
            }
            document.getElementById('reviewCustomer').innerHTML = customerInfo;
            
            // Cake details
            const cakeSize = document.getElementById('cakeSize').selectedOptions[0].text;
            const layerSections = document.querySelectorAll('.layer-section');
            let layersInfo = '';
            layerSections.forEach((layer, index) => {
                const selects = layer.querySelectorAll('select');
                layersInfo += `
                    <div class="review-detail">
                        <div class="review-label">Layer ${index + 1}:</div>
                        <div class="review-value">
                            ${selects[0].selectedOptions[0].text} cake, 
                            ${selects[1].selectedOptions[0].text} filling, 
                            ${selects[2].selectedOptions[0].text} icing, 
                            ${selects[3].selectedOptions[0].text} color
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('reviewCake').innerHTML = `
                <div class="review-detail"><div class="review-label">Size:</div><div class="review-value">${cakeSize}</div></div>
                ${layersInfo}
                <div class="review-detail"><div class="review-label">Pickup Date:</div><div class="review-value">${document.getElementById('pickupDate').value}</div></div>
                <div class="review-detail"><div class="review-label">Pickup Time:</div><div class="review-value">${document.getElementById('pickupTime').value}</div></div>
            `;
            
            // Customization
            const writing = document.getElementById('cakeWriting').value || 'None';
            const decoration = document.getElementById('decorationDetails').selectedOptions[0]?.text || 'None';
            const instructions = document.getElementById('specialInstructions').value || 'None';
            
            document.getElementById('reviewCustomization').innerHTML = `
                <div class="review-detail"><div class="review-label">Writing:</div><div class="review-value">${writing}</div></div>
                <div class="review-detail"><div class="review-label">Decoration:</div><div class="review-value">${decoration}</div></div>
                <div class="review-detail"><div class="review-label">Special Instructions:</div><div class="review-value">${instructions}</div></div>
                <div class="review-detail"><div class="review-label">Reference Photos:</div><div class="review-value">${uploadedPhotos.length} photo(s)</div></div>
            `;
            
            // Pricing
            document.getElementById('reviewPricing').innerHTML = `
                <div class="review-detail"><div class="review-label">Base Cake:</div><div class="review-value">${document.getElementById('summaryBaseCake').textContent}</div></div>
                <div class="review-detail"><div class="review-label">Extra Layers:</div><div class="review-value">${document.getElementById('summaryExtraLayers').textContent}</div></div>
                <div class="review-detail"><div class="review-label">Reference Photos:</div><div class="review-value">${document.getElementById('summaryPhotos').textContent}</div></div>
                <div class="review-detail"><div class="review-label"><strong>TOTAL:</strong></div><div class="review-value"><strong>${document.getElementById('summaryTotal').textContent}</strong></div></div>
                <div class="review-detail"><div class="review-label">Deposit (50%):</div><div class="review-value">${document.getElementById('summaryDeposit').textContent}</div></div>
            `;
        }

        function submitOrder() {
            // Create or get customer
            let customerId;
            if (selectedCustomer) {
                customerId = selectedCustomer.id;
            } else {
                // Create new customer
                customerId = Math.max(...unifiedMockData.customers.map(c => c.id)) + 1;
                const newCustomer = {
                    id: customerId,
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    mobilePhone: document.getElementById('mobilePhone').value,
                    email: document.getElementById('email').value,
                    addressLine1: document.getElementById('addressLine1').value,
                    addressLine2: document.getElementById('addressLine2').value,
                    stateId: 48, // Texas
                    zipCode: document.getElementById('zipCode').value,
                    typeId: 1, // Retail
                    statusId: 1, // Active
                    isPreferred: 'N'
                };
                unifiedMockData.customers.push(newCustomer);
            }
            
            // Get cake details
            const cakeSizeData = document.getElementById('cakeSize').value.split('|');
            const totalPrice = parseFloat(document.getElementById('summaryTotal').textContent.replace('$', ''));
            const depositAmount = parseFloat(document.getElementById('summaryDeposit').textContent.replace('$', ''));
            
            // Collect layer details
            const layers = [];
            document.querySelectorAll('.layer-section').forEach((layer, index) => {
                const selects = layer.querySelectorAll('select');
                layers.push({
                    layerNumber: index + 1,
                    flavor: selects[0].value,
                    filling: selects[1].value,
                    icing: selects[2].value,
                    color: selects[3].value
                });
            });
            
            // Create new order
            const newOrderId = Math.max(...unifiedMockData.orders.map(o => o.id)) + 1;
            const newOrder = {
                id: newOrderId,
                customerId: customerId,
                productId: 1, // Generic cake product
                orderDate: new Date().toISOString().split('T')[0],
                pickupDate: document.getElementById('pickupDate').value,
                pickupTime: document.getElementById('pickupTime').value,
                totalPrice: totalPrice,
                depositAmount: depositAmount,
                statusId: 1, // New order
                isCancelled: 'N',
                cakeSize: cakeSizeData[0],
                layers: layers,
                writing: document.getElementById('cakeWriting').value,
                decoration: document.getElementById('decorationDetails').value,
                notes: document.getElementById('specialInstructions').value,
                referencePhotos: uploadedPhotos.length,
                decorationNotes: document.getElementById('cakeWriting').value
            };
            
            unifiedMockData.orders.push(newOrder);
            
            // Show success and redirect
            alert(`Order #${newOrderId} created successfully! Redirecting to orders page...`);
            window.location.href = 'dashboard/all-orders.html';
        }
    </script>
</body>
</html>
