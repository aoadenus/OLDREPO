<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Customer - Emily Bakes Cakes</title>
    <link rel="stylesheet" href="css/dashboard-redesigned.css">
    <script src="js/ux-enhancements.js"></script>
    <style>
        .form-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            color: #C44569;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #C44569;
            box-shadow: 0 0 0 3px rgba(196, 69, 105, 0.1);
        }

        .form-group textarea {
            grid-column: 1 / -1;
            resize: vertical;
            min-height: 100px;
        }

        .required-indicator {
            color: #EF4444;
            margin-left: 4px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .btn-submit {
            background: #C44569;
            color: white;
            padding: 12px 32px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-submit:hover {
            background: #a83a54;
        }

        .btn-reset {
            background: #f0f0f0;
            color: #333;
            padding: 12px 32px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-reset:hover {
            background: #e0e0e0;
        }

        .btn-cancel {
            background: transparent;
            color: #C44569;
            padding: 12px 32px;
            border: 2px solid #C44569;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel:hover {
            background: #C44569;
            color: white;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        @media (max-width: 1024px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-group.full-width {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .form-container {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn-submit,
            .btn-reset,
            .btn-cancel {
                width: 100%;
            }
        }

        @media (max-width: 640px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-container {
                padding: 20px 16px;
            }
            
            .section-title {
                font-size: 16px;
            }
        }

        .success-message {
            display: none;
            background: #10B981;
            color: white;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .error-message {
            display: none;
            background: #EF4444;
            color: white;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .duplicate-warning {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            color: #92400E;
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .duplicate-warning a {
            color: #C44569;
            text-decoration: underline;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            top: 90px;
            right: 24px;
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-left: 4px solid #10B981;
        }

        .toast.error {
            border-left: 4px solid #EF4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-left">
            <div class="header-logo">
                <div class="logo-text">Emily Bakes Cakes</div>
            </div>
        </div>
        <div class="header-right">
            <button class="header-btn" onclick="backToSite()">‚Üê Back to Site</button>
            <button class="logout-btn header-btn" onclick="handleLogout()">Logout</button>
        </div>
    </header>

    <!-- LEFT NAVIGATION -->
    <nav class="nav-sidebar">
        <ul>
            <li><a href="#" onclick="goToDashboard(); return false;" class="nav-link">Dashboard</a></li>
            <li><a href="all-orders.html" class="nav-link">View Orders</a></li>
            <li><a href="all-customers.html" class="nav-link">View Customers</a></li>
            <li><a href="view-products.html" class="nav-link">View Products</a></li>
            <li><a href="reports.html" class="nav-link">Reports</a></li>
        </ul>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="content">
            <!-- PAGE HEADER -->
            <div class="page-header">
                <h1 class="page-title">Add New Customer</h1>
                <p class="page-subtitle">Create a new customer profile in the system</p>
            </div>

            <!-- TOAST NOTIFICATION -->
            <div id="toast" class="toast"></div>

            <!-- FORM CONTAINER -->
            <div class="form-container">
                <form id="newCustomerForm" onsubmit="handleSubmit(event)">

                    <!-- PERSONAL INFORMATION SECTION -->
                    <div class="form-section">
                        <div class="section-title">üë§ Personal Information</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="firstName">First Name <span class="required-indicator">*</span></label>
                                <input type="text" id="firstName" name="firstName" required maxlength="25">
                            </div>

                            <div class="form-group">
                                <label for="middleInit">Middle Initial</label>
                                <input type="text" id="middleInit" name="middleInit" maxlength="1">
                            </div>

                            <div class="form-group">
                                <label for="lastName">Last Name <span class="required-indicator">*</span></label>
                                <input type="text" id="lastName" name="lastName" required maxlength="50">
                            </div>

                            <div class="form-group">
                                <label for="companyName">Company Name</label>
                                <input type="text" id="companyName" name="companyName" maxlength="60">
                            </div>

                            <div class="form-group">
                                <label for="custType">Customer Type <span class="required-indicator">*</span></label>
                                <select id="custType" name="custType" required>
                                    <option value="">-- Select Type --</option>
                                    <option value="1">Retail (Individual)</option>
                                    <option value="2">Corporate (Business)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="custStatus">Customer Status <span class="required-indicator">*</span></label>
                                <select id="custStatus" name="custStatus" required>
                                    <option value="">-- Select Status --</option>
                                    <option value="1">Active</option>
                                    <option value="2">Inactive</option>
                                    <option value="3">Prospect</option>
                                    <option value="4">Do Not Contact</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ADDRESS INFORMATION SECTION -->
                    <div class="form-section">
                        <div class="section-title">üìç Address Information</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="addrLine1">Address Line 1 <span class="required-indicator">*</span></label>
                                <input type="text" id="addrLine1" name="addrLine1" required maxlength="60">
                            </div>

                            <div class="form-group">
                                <label for="addrLine2">Address Line 2</label>
                                <input type="text" id="addrLine2" name="addrLine2" maxlength="60">
                            </div>

                            <div class="form-group">
                                <label for="state">State / Province <span class="required-indicator">*</span></label>
                                <select id="state" name="state" required>
                                    <option value="">-- Select State --</option>
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OH">Ohio</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX" selected>Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="zipCode">Zip Code <span class="required-indicator">*</span></label>
                                <input type="text" id="zipCode" name="zipCode" required maxlength="10" placeholder="12345 or A1A 1A1">
                            </div>

                            <div class="form-group">
                                <label for="country">Country <span class="required-indicator">*</span></label>
                                <select id="country" name="country" required>
                                    <option value="">-- Select Country --</option>
                                    <option value="1" selected>United States</option>
                                    <option value="2">Canada</option>
                                    <option value="3">Mexico</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- CONTACT INFORMATION SECTION -->
                    <div class="form-section">
                        <div class="section-title">üìû Contact Information</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="mobilePhone">Mobile Phone <span class="required-indicator">*</span></label>
                                <input type="tel" id="mobilePhone" name="mobilePhone" required maxlength="20" placeholder="(999) 999-9999">
                                <p class="help-text">Format: (999) 999-9999</p>
                            </div>

                            <div class="form-group">
                                <label for="workPhone">Work Phone</label>
                                <input type="tel" id="workPhone" name="workPhone" maxlength="20" placeholder="(999) 999-9999">
                                <p class="help-text">Format: (999) 999-9999</p>
                            </div>

                            <div class="form-group">
                                <label for="homePhone">Home Phone</label>
                                <input type="tel" id="homePhone" name="homePhone" maxlength="20" placeholder="(999) 999-9999">
                                <p class="help-text">Format: (999) 999-9999</p>
                            </div>

                            <div class="form-group">
                                <label for="email">Email Address <span class="required-indicator">*</span></label>
                                <input type="email" id="email" name="email" required maxlength="40">
                                <div id="duplicateWarning" class="duplicate-warning" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ADDITIONAL INFORMATION SECTION -->
                    <div class="form-section">
                        <div class="section-title">üìù Additional Information</div>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="comments">Comments About Customer</label>
                                <textarea id="comments" name="comments" maxlength="1000" placeholder="Enter any additional notes about this customer..."></textarea>
                                <p class="help-text">Maximum 1000 characters</p>
                            </div>

                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="preferredCustomer" name="preferredCustomer">
                                    <label for="preferredCustomer">Mark as Preferred Customer (Eligible for discounts)</label>
                                </div>
                                <p class="help-text">Preferred customers receive special discounts and priority service</p>
                            </div>
                        </div>
                    </div>

                    <!-- ACTION BUTTONS -->
                    <div class="form-actions form-actions-sticky">
                        <button type="submit" class="btn-submit">‚úÖ Create Customer</button>
                        <button type="reset" class="btn-reset">üîÑ Clear Form</button>
                        <button type="button" class="btn-cancel" onclick="goToCustomers()">‚úï Cancel</button>
                    </div>

                </form>
            </div>

        </div>
    </main>

    <!-- SCRIPTS -->
    <script src="js/unified-mock-data.js"></script>
    <script>
        // Auto-format phone numbers
        function formatPhoneNumber(input) {
            const value = input.value.replace(/\D/g, '');
            if (value.length <= 3) {
                input.value = value ? `(${value}` : '';
            } else if (value.length <= 6) {
                input.value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            } else {
                input.value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
            }
        }

        // Add event listeners to phone inputs
        ['mobilePhone', 'homePhone', 'workPhone'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', function() {
                    formatPhoneNumber(this);
                });
            }
        });

        // Add event listeners for duplicate check
        ['email', 'mobilePhone'].forEach(fieldId => {
            const input = document.getElementById(fieldId);
            if (input) {
                input.addEventListener('blur', checkDuplicate);
            }
        });

        // Add event listener for country change to update ZIP placeholder
        const countrySelect = document.getElementById('country');
        if (countrySelect) {
            countrySelect.addEventListener('change', updateZipPlaceholder);
        }

        // Add event listener for ZIP validation
        const zipInput = document.getElementById('zipCode');
        if (zipInput) {
            zipInput.addEventListener('input', validateZipByCountry);
        }

        // Update ZIP placeholder based on country
        function updateZipPlaceholder() {
            const country = document.getElementById('country').value;
            const zipInput = document.getElementById('zipCode');
            
            switch(country) {
                case '1': // United States
                    zipInput.placeholder = "12345 or 12345-6789";
                    zipInput.pattern = "[0-9]{5}(-[0-9]{4})?";
                    break;
                case '2': // Canada
                    zipInput.placeholder = "A1A 1A1";
                    zipInput.pattern = "[A-Z][0-9][A-Z] [0-9][A-Z][0-9]";
                    break;
                case '3': // Mexico
                    zipInput.placeholder = "12345";
                    zipInput.pattern = "[0-9]{5}";
                    break;
                default:
                    zipInput.placeholder = "12345 or A1A 1A1";
                    zipInput.pattern = "";
            }
        }

        // Validate ZIP code based on selected country
        function validateZipByCountry() {
            const zipInput = document.getElementById('zipCode');
            const country = document.getElementById('country').value;
            
            // Remove validation message
            zipInput.setCustomValidity('');
            
            if (!zipInput.value) return;
            
            // Validate based on country
            const value = zipInput.value.trim();
            let isValid = true;
            
            if (country === '1') { // United States
                isValid = /^[0-9]{5}(-[0-9]{4})?$/.test(value);
                if (!isValid) {
                    zipInput.setCustomValidity('Please enter a valid US ZIP code (e.g., 12345 or 12345-6789)');
                }
            } else if (country === '2') { // Canada
                isValid = /^[A-Z][0-9][A-Z] [0-9][A-Z][0-9]$/i.test(value);
                if (!isValid) {
                    zipInput.setCustomValidity('Please enter a valid Canadian postal code (e.g., A1A 1A1)');
                }
            } else if (country === '3') { // Mexico
                isValid = /^[0-9]{5}$/.test(value);
                if (!isValid) {
                    zipInput.setCustomValidity('Please enter a valid Mexican postal code (5 digits)');
                }
            }
        }

        // Check for duplicate customers
        function checkDuplicate() {
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('mobilePhone').value.trim();
            
            if (!email && !phone) return;
            
            // Check if customer exists in unifiedMockData
            const existing = unifiedMockData.customers.find(c => 
                (email && c.email === email) || (phone && c.mobilePhone === phone)
            );
            
            const warning = document.getElementById('duplicateWarning');
            
            if (existing) {
                const matchField = existing.email === email ? 'email' : 'phone';
                warning.style.display = 'flex';
                warning.innerHTML = `‚ö†Ô∏è A customer with this ${matchField} already exists: <strong>${existing.firstName} ${existing.lastName}</strong>. <a href="all-customers.html?id=${existing.id}">View customer</a>`;
            } else {
                warning.style.display = 'none';
            }
        }

        // Show toast notification
        function showToast(type, message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        // Load user info on page load
        window.addEventListener('load', function() {
            loadUserInfo();
        });

        function loadUserInfo() {
            const currentStaff = JSON.parse(sessionStorage.getItem('currentStaff') || '{}');
            if (currentStaff.name) {
                const staffNameEl = document.getElementById('staff-name');
                const staffRoleEl = document.getElementById('staff-role');
                if (staffNameEl) staffNameEl.textContent = currentStaff.name;
                if (staffRoleEl) staffRoleEl.textContent = currentStaff.role || 'Staff';
            } else {
                // Fallback to localStorage
                const userRole = localStorage.getItem('userRole') || 'Staff';
                const userName = localStorage.getItem('userName') || 'Guest User';
                const staffRoleEl = document.getElementById('staff-role');
                const staffNameEl = document.getElementById('staff-name');
                if (staffRoleEl) staffRoleEl.textContent = userRole;
                if (staffNameEl) staffNameEl.textContent = userName;
            }
        }

        function handleSubmit(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            
            // Generate new customer ID
            const newCustomerId = Math.max(...unifiedMockData.customers.map(c => c.id)) + 1;

            // Map state code to stateId
            const stateCode = formData.get('state');
            const stateMapping = {
                'AL': 1, 'AK': 2, 'AZ': 3, 'AR': 4, 'CA': 5, 'CO': 6, 'CT': 7, 'DE': 8, 'FL': 10,
                'GA': 11, 'HI': 12, 'ID': 13, 'IL': 14, 'IN': 15, 'IA': 16, 'KS': 17, 'KY': 18,
                'LA': 19, 'ME': 20, 'MD': 21, 'MA': 22, 'MI': 23, 'MN': 24, 'MS': 25, 'MO': 26,
                'MT': 27, 'NE': 28, 'NV': 29, 'NH': 30, 'NJ': 31, 'NM': 32, 'NY': 33, 'NC': 34,
                'ND': 35, 'OH': 36, 'OK': 37, 'OR': 38, 'PA': 39, 'RI': 40, 'SC': 41, 'SD': 42,
                'TN': 43, 'TX': 48, 'UT': 44, 'VT': 45, 'VA': 46, 'WA': 47, 'WV': 49, 'WI': 50, 'WY': 51
            };
            const stateId = stateMapping[stateCode] || 48;

            // Create new customer object
            const newCustomer = {
                id: newCustomerId,
                statusId: parseInt(formData.get('custStatus')) || 1,
                typeId: parseInt(formData.get('custType')) || 1,
                companyName: formData.get('companyName') || null,
                firstName: formData.get('firstName'),
                middleInitial: formData.get('middleInit') || null,
                lastName: formData.get('lastName'),
                addressLine1: formData.get('addrLine1'),
                addressLine2: formData.get('addrLine2') || null,
                stateId: stateId,
                countryId: parseInt(formData.get('country')) || 1,
                zipCode: formData.get('zipCode'),
                mobilePhone: formData.get('mobilePhone'),
                workPhone: formData.get('workPhone') || null,
                homePhone: formData.get('homePhone') || null,
                email: formData.get('email'),
                comments: formData.get('comments') || null,
                isPreferred: formData.get('preferredCustomer') ? 'Y' : 'N'
            };

            // Add to unified data
            unifiedMockData.customers.push(newCustomer);

            console.log('New customer created:', newCustomer);
            console.log('Total customers:', unifiedMockData.customers.length);

            // Show toast notification
            showToast('success', `‚úì Customer #${newCustomerId} created successfully! (${newCustomer.firstName} ${newCustomer.lastName})`, 2000);

            // Redirect after delay
            setTimeout(() => {
                window.location.href = 'all-customers.html';
            }, 2000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            if (successDiv) {
                successDiv.textContent = '‚úÖ ' + message;
                successDiv.style.display = 'block';
            }
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) errorDiv.style.display = 'none';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = '‚ùå ' + message;
                errorDiv.style.display = 'block';
            }
            const successDiv = document.getElementById('successMessage');
            if (successDiv) successDiv.style.display = 'none';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToCustomers() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                window.location.href = 'all-customers.html';
            }
        }

        function goToDashboard() {
            const currentStaff = JSON.parse(sessionStorage.getItem('currentStaff') || '{}');
            const rolePages = {
                'Manager': 'index.html',
                'Baker': 'baker-dashboard.html',
                'Decorator': 'decorator-dashboard.html',
                'Sales': 'sales-dashboard.html',
                'Accountant': 'accountant-dashboard.html'
            };
            window.location.href = rolePages[currentStaff.role] || 'index.html';
        }

        function backToSite() {
            window.location.href = '../index.html';
        }

        function handleLogout() {
            sessionStorage.clear();
            localStorage.removeItem('userRole');
            localStorage.removeItem('userName');
            window.location.href = '../staff-login.html';
        }
    </script>
    <script src="js/main.js"></script>
</body>
</html>
