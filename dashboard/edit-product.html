<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product - Emily Bakes Cakes</title>
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="css/dashboard-redesigned-consolidated.css">
    <script src="js/ux-enhancements.js"></script>
    <style>
        .form-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-section:last-of-type {
            border-bottom: none;
        }

        .section-title {
            color: #C44569;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #C44569;
            box-shadow: 0 0 0 3px rgba(196, 69, 105, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .required-indicator {
            color: #EF4444;
            margin-left: 4px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .btn-submit {
            background: #C44569;
            color: white;
            padding: 12px 32px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-submit:hover {
            background: #a83a54;
        }

        .btn-reset {
            background: #f0f0f0;
            color: #333;
            padding: 12px 32px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-reset:hover {
            background: #e0e0e0;
        }

        .btn-cancel {
            background: transparent;
            color: #C44569;
            padding: 12px 32px;
            border: 2px solid #C44569;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel:hover {
            background: #C44569;
            color: white;
        }

        .btn-delete {
            background: #EF4444;
            color: white;
            padding: 12px 32px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #DC2626;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .allergen-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .chip-checkbox {
            display: none;
        }

        .chip-label {
            padding: 8px 16px;
            border: 2px solid var(--border-light);
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 13px;
            font-weight: 500;
        }

        .chip-checkbox:checked + .chip-label {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .image-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed var(--border-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            background: var(--bg-light);
            margin-top: 12px;
        }

        .product-info-box {
            background: rgba(196, 69, 105, 0.05);
            border-left: 4px solid #C44569;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 24px;
        }

        .product-info-box h3 {
            color: #C44569;
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .product-info-box p {
            margin: 4px 0;
            color: #666;
            font-size: 14px;
        }

        .danger-zone {
            background: rgba(239, 68, 68, 0.05);
            border: 2px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            padding: 24px;
            margin-top: 40px;
        }

        .danger-zone-title {
            color: #EF4444;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .danger-zone-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .form-container {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn-submit,
            .btn-reset,
            .btn-cancel,
            .btn-delete {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-left">
            <div class="header-logo">
                <div class="logo-text">Emily Bakes Cakes</div>
            </div>
        </div>
        <div class="header-center">
            <div class="header-user">
                <div class="role-badge" id="staff-role">Staff</div>
                <div class="manager-name" id="staff-name">Loading...</div>
            </div>
        </div>
        <div class="header-right">
            <button class="header-btn" onclick="backToSite()">‚Üê Back to Site</button>
            <button class="logout-btn header-btn" onclick="handleLogout()">Logout</button>
        </div>
    </header>

    <!-- LEFT NAVIGATION -->
    <nav class="nav-sidebar">
        <ul>
            <li><a href="#" onclick="goToDashboard(); return false;" class="nav-link">Dashboard</a></li>
            <li><a href="all-orders.html" class="nav-link">View Orders</a></li>
            <li><a href="all-customers.html" class="nav-link">View Customers</a></li>
            <li><a href="view-products.html" class="nav-link active">View Products</a></li>
            <li><a href="reports.html" class="nav-link">Reports</a></li>
        </ul>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="content">
            <!-- PAGE HEADER -->
            <div class="page-header">
                <h1 class="page-title" id="page-title">Edit Product</h1>
                <p class="page-subtitle" id="page-subtitle">Update product information</p>
            </div>

            <!-- PRODUCT INFO BOX -->
            <div class="product-info-box" id="product-info-box" style="display: none;">
                <h3>üìå Current Product</h3>
                <p><strong>Product Name:</strong> <span id="product-current-name">Loading...</span></p>
                <p><strong>Category:</strong> <span id="product-current-category">Loading...</span></p>
                <p><strong>Current Price:</strong> <span id="product-current-price">Loading...</span></p>
            </div>

            <!-- FORM CONTAINER -->
            <div class="form-container">
                <form id="editProductForm" onsubmit="handleSubmit(event)">

                    <!-- BASIC INFORMATION -->
                    <div class="form-section">
                        <div class="section-title">üéÇ Basic Information</div>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="productName">Product Name <span class="required-indicator">*</span></label>
                                <input type="text" id="productName" name="productName" required maxlength="100" placeholder="e.g., Chocolate Velvet Cake">
                            </div>

                            <div class="form-group full-width">
                                <label for="description">Description <span class="required-indicator">*</span></label>
                                <textarea id="description" name="description" required maxlength="500" placeholder="Describe the cake, its flavors, and what makes it special..."></textarea>
                                <p class="help-text">Maximum 500 characters</p>
                            </div>

                            <div class="form-group">
                                <label for="category">Category <span class="required-indicator">*</span></label>
                                <select id="category" name="category" required>
                                    <option value="">-- Select Category --</option>
                                    <option value="classic">Classic Cakes</option>
                                    <option value="specialty">Specialty Cakes</option>
                                    <option value="seasonal">Seasonal</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="basePrice">Base Price (USD) <span class="required-indicator">*</span></label>
                                <input type="number" id="basePrice" name="basePrice" required step="0.01" min="0" placeholder="0.00">
                                <p class="help-text">Starting price for standard size</p>
                            </div>
                        </div>
                    </div>

                    <!-- PRODUCT DETAILS -->
                    <div class="form-section">
                        <div class="section-title">üìã Product Details</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="emoji">Product Emoji <span class="required-indicator">*</span></label>
                                <input type="text" id="emoji" name="emoji" required maxlength="2" placeholder="üç´" style="font-size: 24px; text-align: center;">
                                <p class="help-text">Used for visual representation</p>
                            </div>

                            <div class="form-group">
                                <label for="prepTime">Prep Time (hours) <span class="required-indicator">*</span></label>
                                <input type="number" id="prepTime" name="prepTime" required min="1" max="72" placeholder="24">
                                <p class="help-text">How long to make this cake</p>
                            </div>

                            <div class="form-group">
                                <label for="servings">Standard Servings <span class="required-indicator">*</span></label>
                                <input type="number" id="servings" name="servings" required min="1" max="200" placeholder="12">
                            </div>

                            <div class="form-group">
                                <label for="availability">Availability <span class="required-indicator">*</span></label>
                                <select id="availability" name="availability" required>
                                    <option value="">-- Select Status --</option>
                                    <option value="available">Available</option>
                                    <option value="unavailable">Unavailable</option>
                                    <option value="seasonal">Seasonal Only</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ALLERGENS & DIETARY -->
                    <div class="form-section">
                        <div class="section-title">‚ö†Ô∏è Allergens & Dietary Information</div>
                        <div class="form-group">
                            <label>Select Allergens <span class="required-indicator">*</span></label>
                            <p class="help-text">Check all allergens present in this product</p>
                            <div class="allergen-chips">
                                <input type="checkbox" id="allergen-eggs" name="allergens" value="Eggs" class="chip-checkbox">
                                <label for="allergen-eggs" class="chip-label">ü•ö Eggs</label>

                                <input type="checkbox" id="allergen-dairy" name="allergens" value="Dairy" class="chip-checkbox">
                                <label for="allergen-dairy" class="chip-label">ü•õ Dairy</label>

                                <input type="checkbox" id="allergen-gluten" name="allergens" value="Gluten" class="chip-checkbox">
                                <label for="allergen-gluten" class="chip-label">üåæ Gluten</label>

                                <input type="checkbox" id="allergen-nuts" name="allergens" value="Nuts" class="chip-checkbox">
                                <label for="allergen-nuts" class="chip-label">ü•ú Nuts</label>

                                <input type="checkbox" id="allergen-soy" name="allergens" value="Soy" class="chip-checkbox">
                                <label for="allergen-soy" class="chip-label">Soy</label>

                                <input type="checkbox" id="allergen-coconut" name="allergens" value="Coconut" class="chip-checkbox">
                                <label for="allergen-coconut" class="chip-label">ü•• Coconut</label>
                            </div>
                        </div>

                        <div class="form-grid" style="margin-top: 24px;">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="glutenFree" name="glutenFree">
                                    <label for="glutenFree">Gluten-Free Option Available</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="dairyFree" name="dairyFree">
                                    <label for="dairyFree">Dairy-Free Option Available</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="vegan" name="vegan">
                                    <label for="vegan">Vegan Option Available</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ADDITIONAL NOTES -->
                    <div class="form-section">
                        <div class="section-title">üìù Additional Information</div>
                        <div class="form-group">
                            <label for="notes">Internal Notes</label>
                            <textarea id="notes" name="notes" maxlength="1000" placeholder="Any special instructions, ingredients, or notes for the baking team..."></textarea>
                            <p class="help-text">For internal use only - not visible to customers</p>
                        </div>
                    </div>

                    <!-- ACTION BUTTONS -->
                    <div class="form-actions form-actions-sticky">
                        <button type="submit" class="btn-submit">‚úÖ Update Product</button>
                        <button type="reset" class="btn-reset">üîÑ Reset Changes</button>
                        <button type="button" class="btn-cancel" onclick="goToProducts()">‚úï Cancel</button>
                    </div>

                </form>

                <!-- DANGER ZONE -->
                <div class="danger-zone">
                    <div class="danger-zone-title">‚ö†Ô∏è Danger Zone</div>
                    <div class="danger-zone-description">
                        Deleting a product is a permanent action. Make sure you really want to delete this product before proceeding.
                    </div>
                    <button type="button" class="btn-delete" onclick="deleteProduct()">üóëÔ∏è Delete This Product</button>
                </div>

            </div>

        </div>
    </main>

    <script src="js/main.js"></script>
    <script>
        let currentProductId = null;
        let currentProduct = null;

        window.addEventListener('load', function() {
            if (!checkAuthentication()) return;
            updateHeaderWithUserInfo();
            initializeNav();

            // Check if user is manager
            const userRole = localStorage.getItem('staffRole');
            if (userRole !== 'manager') {
                showToast('Access denied. Manager role required.', 'error');
                setTimeout(() => {
                    window.location.href = 'view-products.html';
                }, 2000);
                return;
            }

            // Get product ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            currentProductId = parseInt(urlParams.get('id'));

            if (!currentProductId) {
                showToast('No product ID provided', 'error');
                setTimeout(() => {
                    window.location.href = 'view-products.html';
                }, 2000);
                return;
            }

            loadProductData();
        });

        function loadProductData() {
            // Get products from localStorage
            let products = JSON.parse(localStorage.getItem('products') || '[]');
            
            // Find the product
            currentProduct = products.find(p => p.id === currentProductId);

            if (!currentProduct) {
                showToast('Product not found', 'error');
                setTimeout(() => {
                    window.location.href = 'view-products.html';
                }, 2000);
                return;
            }

            // Populate form with product data
            document.getElementById('productName').value = currentProduct.name || '';
            document.getElementById('description').value = currentProduct.description || '';
            document.getElementById('category').value = currentProduct.category || '';
            document.getElementById('basePrice').value = currentProduct.price || '';
            document.getElementById('emoji').value = currentProduct.image || '';
            document.getElementById('prepTime').value = currentProduct.prepTime || '24';
            document.getElementById('servings').value = currentProduct.servings || '12';
            document.getElementById('availability').value = currentProduct.available ? 'available' : 'unavailable';
            document.getElementById('notes').value = currentProduct.notes || '';

            // Set dietary checkboxes
            if (currentProduct.glutenFree) document.getElementById('glutenFree').checked = true;
            if (currentProduct.dairyFree) document.getElementById('dairyFree').checked = true;
            if (currentProduct.vegan) document.getElementById('vegan').checked = true;

            // Set allergen checkboxes
            if (currentProduct.allergens && Array.isArray(currentProduct.allergens)) {
                currentProduct.allergens.forEach(allergen => {
                    const checkbox = document.querySelector(`input[name="allergens"][value="${allergen}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            // Update product info box
            document.getElementById('product-info-box').style.display = 'block';
            document.getElementById('product-current-name').textContent = currentProduct.name;
            document.getElementById('product-current-category').textContent = currentProduct.category;
            document.getElementById('product-current-price').textContent = `$${parseFloat(currentProduct.price).toFixed(2)}`;
        }

        function handleSubmit(event) {
            event.preventDefault();

            // Validate form first
            if (!validateForm('editProductForm')) {
                return;
            }

            // Get allergens
            const allergens = Array.from(document.querySelectorAll('input[name="allergens"]:checked'))
                .map(cb => cb.value);

            if (allergens.length === 0) {
                showToast('Please select at least one allergen', 'error');
                return;
            }

            // Show loading state
            const submitBtn = event.target.querySelector('.btn-submit');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';

            // Get form data
            const updatedData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('description').value,
                category: document.getElementById('category').value,
                price: parseFloat(document.getElementById('basePrice').value),
                image: document.getElementById('emoji').value,
                prepTime: parseInt(document.getElementById('prepTime').value),
                servings: parseInt(document.getElementById('servings').value),
                available: document.getElementById('availability').value === 'available',
                allergens: allergens,
                glutenFree: document.getElementById('glutenFree').checked,
                dairyFree: document.getElementById('dairyFree').checked,
                vegan: document.getElementById('vegan').checked,
                notes: document.getElementById('notes').value,
                updatedAt: new Date().toISOString(),
                updatedBy: localStorage.getItem('staffName')
            };

            // Get all products and update the specific one
            let products = JSON.parse(localStorage.getItem('products') || '[]');
            const productIndex = products.findIndex(p => p.id === currentProductId);

            if (productIndex === -1) {
                showToast('Product not found in database', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }

            // Preserve creation metadata while updating other fields
            products[productIndex] = {
                ...products[productIndex],
                ...updatedData
            };

            // Save updated products
            localStorage.setItem('products', JSON.stringify(products));

            // Show success toast
            showToast(`Product "${updatedData.name}" updated successfully!`, 'success');

            // Restore button state
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;

            // Redirect to products page after 2 seconds
            setTimeout(() => {
                window.location.href = 'all-products.html';
            }, 2000);
        }

        function deleteProduct() {
            confirmAction(
                `Are you sure you want to delete "${currentProduct.name}"? This action cannot be undone.`,
                deleteProductConfirmed
            );
        }

        function deleteProductConfirmed() {
            // Get all products and remove this one
            let products = JSON.parse(localStorage.getItem('products') || '[]');
            products = products.filter(p => p.id !== currentProductId);

            // Save updated products
            localStorage.setItem('products', JSON.stringify(products));

            // Close modal and show success
            closeModal();
            showToast(`${currentProduct.name} deleted successfully`, 'success');

            // Redirect to products page after 2 seconds
            setTimeout(() => {
                window.location.href = 'view-products.html';
            }, 2000);
        }

        function goToProducts() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                window.location.href = 'view-products.html';
            }
        }

        function backToSite() {
            window.location.href = '../index.html';
        }

        function handleLogout() {
            localStorage.clear();
            window.location.href = '../staff-login.html';
        }
    </script>
</body>
</html>
